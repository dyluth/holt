# **Feature design: Agent Name IS Role**

**Purpose**: Simplify agent identity by eliminating redundant role field
**Scope**: Phase 3 Coordination - Milestone 7
**Estimated tokens**: ~4,200 tokens
**Read when**: Implementing agent identity simplification, refactoring configuration

Associated phase: **Coordination (Phase 3)**
Status: **Draft**

***Template purpose:*** This document specifies M3.7, a fundamental architectural clarification that eliminates the redundant separation between agent "name" and "role". This simplification improves system clarity, reduces configuration complexity, and aligns container naming with agent identity.

## **1. The 'why': goal and success criteria**

### **1.1. Goal statement**

Eliminate the confusing separation between agent "name" and "role" by making the agent's key in `holt.yml` serve as its role identity, simplifying configuration, container naming, and system reasoning.

### **1.2. User story**

As a Holt user or developer, I want agent identity to be clear and unambiguous so that:
1. There's ONE identifier for each agent (not two: name and role)
2. Container names directly reflect agent identity (`holt-{instance}-Writer` instead of `holt-agent-{instance}-recipe-drafter`)
3. Configuration is simpler (no redundant `role:` field)
4. Feedback routing is obvious (agent key = role = identity)
5. Controller-worker pattern naming is consistent (`Writer-worker-{claim_id}`)

This reduces cognitive load and makes the system more maintainable.

### **1.3. Success criteria**

1. **Config simplified**: Agent key IS the role, no separate `role:` field
2. **Container naming**: `holt-{instance}-{role}` for traditional/controller, `holt-{instance}-{role}-worker-{claim_id}` for workers
3. **Validation enforced**: Config validation ensures role uniqueness within instance
4. **Feedback routing**: Works correctly with agent key as role identifier
5. **Demo updated**: Recipe demo uses `Writer`, `Validator`, `Formatter` as agent keys
6. **Image naming**: Demo images named `holt-{role}-{purpose}:latest` (e.g., `holt-writer-recipe-demo:latest`)
7. **Artefacts unchanged**: `produced_by_role` field still works (now matches agent key)
8. **Documentation updated**: All docs reflect agent key = role identity
9. **No backward compatibility**: Clean break, no migration path (acceptable at this stage)
10. **Tests passing**: All existing tests updated and passing with new structure

### **1.4. Non-goals**

- **Cross-instance role coordination** (Phase 4+): Roles are unique within instance, not globally
- **Role inheritance/hierarchy** (Future): No parent/child role relationships
- **Dynamic role assignment** (Future): Roles are static at startup
- **Role-based permissions** (Phase 4): Beyond basic workspace mode
- **Backward compatibility** (Acceptable): Clean break is preferred over migration complexity

## **2. The 'what': component impact analysis**

### **2.1. Blackboard changes**

**No changes required**.

The `Artefact.ProducedByRole` field continues to work as-is:
```go
type Artefact struct {
    // ... other fields ...
    ProducedByRole string `json:"produced_by_role"` // Agent's role = agent key now
}
```

Since agent key = role, this field remains semantically correct.

### **2.2. Orchestrator changes**

**Minor changes required** for consistent naming and validation.

#### **2.2.1. Config loading**

Update `internal/config/config.go`:

```go
// HoltConfig represents the top-level holt.yml configuration
type HoltConfig struct {
    Version      string              `yaml:"version"`
    Orchestrator *OrchestratorConfig `yaml:"orchestrator,omitempty"`
    Agents       map[string]Agent    `yaml:"agents"` // Key IS the role
    Services     *ServicesConfig     `yaml:"services,omitempty"`
}

// Agent represents a single agent configuration
type Agent struct {
    // REMOVED: Role string `yaml:"role"` - agent key IS the role
    Image           string           `yaml:"image"`
    Build           *BuildConfig     `yaml:"build,omitempty"`
    Command         []string         `yaml:"command"`
    BidScript       []string         `yaml:"bid_script,omitempty"`
    Workspace       *WorkspaceConfig `yaml:"workspace,omitempty"`
    Replicas        *int             `yaml:"replicas,omitempty"`
    Strategy        string           `yaml:"strategy,omitempty"`
    BiddingStrategy string           `yaml:"bidding_strategy,omitempty"`
    Environment     []string         `yaml:"environment,omitempty"`
    Resources       *ResourcesConfig `yaml:"resources,omitempty"`
    Prompts         *PromptsConfig   `yaml:"prompts,omitempty"`
    Mode            string           `yaml:"mode,omitempty"`
    Worker          *WorkerConfig    `yaml:"worker,omitempty"`
}
```

#### **2.2.2. Config validation**

Update validation in `internal/config/config.go`:

```go
func (c *HoltConfig) Validate() error {
    // ... existing validation ...

    // M3.7: Validate agent keys (which are now roles)
    for agentRole := range c.Agents {
        if err := validateRoleName(agentRole); err != nil {
            return fmt.Errorf("invalid agent role '%s': %w", agentRole, err)
        }
    }

    // Role uniqueness is guaranteed by map keys (no duplicates possible)
    // But we should validate role names follow conventions

    return nil
}

// validateRoleName ensures role names follow conventions
// Rules: PascalCase, alphanumeric, 1-64 chars
func validateRoleName(role string) error {
    if role == "" {
        return fmt.Errorf("role cannot be empty")
    }
    if len(role) > 64 {
        return fmt.Errorf("role name too long (max 64 chars)")
    }
    // Check PascalCase convention (starts with uppercase)
    if role[0] < 'A' || role[0] > 'Z' {
        return fmt.Errorf("role should start with uppercase letter (PascalCase)")
    }
    // Check alphanumeric (allowing hyphens for compound roles like "Code-Reviewer")
    for _, ch := range role {
        if !((ch >= 'A' && ch <= 'Z') || (ch >= 'a' && ch <= 'z') ||
             (ch >= '0' && ch <= '9') || ch == '-') {
            return fmt.Errorf("role must be alphanumeric with optional hyphens")
        }
    }
    return nil
}
```

#### **2.2.3. Agent registry**

The orchestrator's agent registry now maps directly:

```go
// Agent registry: role -> role (simplified, but kept for interface consistency)
agentRegistry := make(map[string]string)
for agentRole := range config.Agents {
    agentRegistry[agentRole] = agentRole // Both key and value are the role
}
```

Actually, this can be simplified further - we just need to check if an agent exists:

```go
// findAgentByRole simplified - agent key IS the role
func (e *Engine) findAgentByRole(role string) (string, error) {
    if _, exists := e.config.Agents[role]; exists {
        return role, nil // Agent name = role
    }
    return "", fmt.Errorf("no agent found with role '%s'", role)
}
```

#### **2.2.4. Container naming**

Update container name generation in orchestrator's worker manager:

```go
// WorkerManager.LaunchWorker now uses role-based naming
func (wm *WorkerManager) LaunchWorker(ctx context.Context, claim *blackboard.Claim, agentRole string) error {
    // Container name: holt-{instance}-{role}-worker-{claim_id}
    containerName := dockerpkg.WorkerContainerName(wm.instanceName, agentRole, claim.ID)
    // ... rest of implementation
}
```

### **2.3. Agent pup changes**

**Minor environment variable changes**.

#### **2.3.1. Pup config**

Update `internal/pup/config.go`:

```go
type Config struct {
    InstanceName string
    AgentName    string // This IS the role now
    AgentRole    string // DEPRECATED: Keep for compatibility during transition, should equal AgentName
    RedisURL     string
    Command      []string
    BiddingStrategy blackboard.BidType
    BidScript    []string
}

func LoadConfig() (*Config, error) {
    cfg := &Config{
        InstanceName: os.Getenv("HOLT_INSTANCE_NAME"),
        AgentName:    os.Getenv("HOLT_AGENT_NAME"),    // Now this is the role
        AgentRole:    os.Getenv("HOLT_AGENT_ROLE"),    // Redundant but kept temporarily
        RedisURL:     os.Getenv("REDIS_URL"),
    }

    // ... rest of loading ...

    return cfg, nil
}

func (c *Config) Validate() error {
    // ... existing validation ...

    // M3.7: Validate that AgentName and AgentRole match (during transition)
    if c.AgentRole != "" && c.AgentName != c.AgentRole {
        return fmt.Errorf("HOLT_AGENT_NAME (%s) must equal HOLT_AGENT_ROLE (%s)",
            c.AgentName, c.AgentRole)
    }

    return nil
}
```

**Note**: Eventually we can remove `HOLT_AGENT_ROLE` entirely and only use `HOLT_AGENT_NAME`.

### **2.4. CLI changes**

**Significant changes** to container naming and environment variables.

#### **2.4.1. Container naming functions**

Update `internal/docker/labels.go`:

```go
// AgentContainerName returns the agent container name
// M3.7: Now uses role-based naming
func AgentContainerName(instanceName, agentRole string) string {
    return fmt.Sprintf("holt-%s-%s", instanceName, agentRole)
}

// WorkerContainerName returns the worker container name for controller-worker pattern
func WorkerContainerName(instanceName, agentRole, claimID string) string {
    return fmt.Sprintf("holt-%s-%s-worker-%s", instanceName, agentRole, claimID)
}
```

**Before:** `holt-agent-default-1-recipe-drafter`
**After:** `holt-default-1-Writer`

**Before (worker):** `holt-agent-default-1-recipe-drafter-worker-abc123`
**After (worker):** `holt-default-1-Writer-worker-abc123`

#### **2.4.2. Agent container launch**

Update `cmd/holt/commands/up.go`:

```go
func launchAgentContainer(ctx context.Context, cli *client.Client, instanceName, runID,
    workspacePath, networkName, redisName, agentRole string, agent config.Agent) error {

    // M3.7: Use role-based naming
    containerName := dockerpkg.AgentContainerName(instanceName, agentRole)
    labels := dockerpkg.BuildLabels(instanceName, runID, workspacePath, "agent")
    labels[dockerpkg.LabelAgentName] = agentRole  // Agent name = role
    labels[dockerpkg.LabelAgentRole] = agentRole  // Same value (redundant but harmless)

    // Build environment variables
    redisURL := fmt.Sprintf("redis://%s:6379", redisName)
    env := []string{
        fmt.Sprintf("HOLT_INSTANCE_NAME=%s", instanceName),
        fmt.Sprintf("HOLT_AGENT_NAME=%s", agentRole),    // This is the role
        fmt.Sprintf("HOLT_AGENT_ROLE=%s", agentRole),    // Redundant but kept for now
        fmt.Sprintf("REDIS_URL=%s", redisURL),
    }

    // ... rest of launch logic
}
```

#### **2.4.3. Agent iteration**

Update the loop that launches agents:

```go
// Launch agent containers in parallel
for agentRole, agent := range cfg.Agents {  // Key is now the role
    // ... parallel launch logic ...
    go func(role string, agentCfg config.Agent) {
        err := launchAgentContainer(ctx, cli, instanceName, runID,
            workspacePath, networkName, redisName, role, agentCfg)
        // ...
    }(agentRole, agent)
}
```

### **2.5. Config changes**

**Breaking change** to `holt.yml` structure.

#### **2.5.1. New config format**

**Before (M3.6 and earlier):**
```yaml
version: "1.0"
agents:
  recipe-drafter:              # Agent "name" (arbitrary)
    role: "Writer"             # Agent "role" (semantic)
    image: recipe-drafter-agent:latest
    command: ["/app/run.sh"]

  recipe-validator:
    role: "Validator"
    image: recipe-validator-agent:latest
```

**After (M3.7):**
```yaml
version: "1.0"
agents:
  Writer:                      # Agent key IS the role (PascalCase convention)
    image: holt-writer-recipe-demo:latest
    command: ["/app/run.sh"]

  Validator:                   # Clear, semantic role identity
    image: holt-validator-recipe-demo:latest
```

#### **2.5.2. Role naming conventions**

Recommended conventions for role names:

- **PascalCase**: `Writer`, `CodeReviewer`, `TestRunner`
- **Semantic**: Name describes capability, not implementation
- **Concise**: 1-2 words preferred
- **Unique**: Within the instance (enforced by map keys)

**Good examples:**
- `Writer`, `Validator`, `Formatter`
- `CodeReviewer`, `TestRunner`, `DocGenerator`
- `Planner`, `Executor`, `Monitor`

**Avoid:**
- `recipe-drafter` (kebab-case, implementation detail)
- `agent1`, `agent2` (meaningless)
- `the_writer_agent` (snake_case, redundant "agent")

## **3. The 'how': implementation & testing plan**

### **3.1. Key design decisions & risks**

**Decision 1: Remove `role` field entirely**
- **Why**: Eliminates redundancy, forces clarity
- **Alternative**: Keep both, validate they match - rejected as still confusing
- **Risk**: Breaking change for existing configs
- **Mitigation**: Acceptable at this stage (Phase 3, limited adoption)

**Decision 2: PascalCase convention for roles**
- **Why**: Matches Go conventions, clearly distinguishes from kebab-case container names
- **Alternative**: kebab-case, snake_case - rejected as less clear
- **Risk**: Users might not follow convention
- **Mitigation**: Validation warns but doesn't enforce (allows flexibility)

**Decision 3: No backward compatibility**
- **Why**: Clean break is simpler than migration
- **Alternative**: Support both formats - rejected as complexity not worth it
- **Risk**: Users must update configs manually
- **Mitigation**: Clear migration guide, simple transformation

**Decision 4: Container naming drops "agent" prefix**
- **Why**: Shorter, clearer (`holt-{instance}-Writer` vs `holt-agent-{instance}-recipe-drafter`)
- **Alternative**: Keep prefix for disambiguation - rejected as unnecessary
- **Risk**: Might conflict with other containers
- **Mitigation**: `holt-` prefix is sufficient disambiguation

### **3.2. Implementation steps**

#### **Phase 1: Core changes (config and validation)**

1. **[Config]** Remove `Role` field from `Agent` struct in `internal/config/config.go`
2. **[Config]** Add `validateRoleName()` function with PascalCase check
3. **[Config]** Update `HoltConfig.Validate()` to validate agent keys as roles
4. **[Config]** Remove role uniqueness check (map keys are already unique)
5. **[Config]** Update tests in `internal/config/config_test.go`

#### **Phase 2: Container naming**

6. **[Docker]** Update `AgentContainerName()` in `internal/docker/labels.go`
7. **[Docker]** Add `WorkerContainerName()` for controller-worker pattern
8. **[CLI]** Update `launchAgentContainer()` in `cmd/holt/commands/up.go`
9. **[CLI]** Update agent iteration loop to use `agentRole` as key
10. **[CLI]** Update environment variable setting (HOLT_AGENT_NAME = role)
11. **[Orchestrator]** Update `WorkerManager.LaunchWorker()` to use new naming

#### **Phase 3: Orchestrator logic**

12. **[Orchestrator]** Simplify `findAgentByRole()` in `internal/orchestrator/feedback_loop.go`
13. **[Orchestrator]** Update agent registry initialization (if needed)
14. **[Orchestrator]** Verify feedback claim routing works with new structure

#### **Phase 4: Pup changes**

15. **[Pup]** Update `Config` struct comments in `internal/pup/config.go`
16. **[Pup]** Add validation that HOLT_AGENT_NAME == HOLT_AGENT_ROLE (transitional)
17. **[Pup]** Update tests in `internal/pup/*_test.go`

#### **Phase 5: Demo refactor**

18. **[Demo]** Update `demos/recipe-generator/holt.yml` with new structure
19. **[Demo]** Rename demo images:
    - `recipe-drafter-agent:latest` → `holt-writer-recipe-demo:latest`
    - `recipe-validator-agent:latest` → `holt-validator-recipe-demo:latest`
    - `recipe-formatter-agent:latest` → `holt-formatter-recipe-demo:latest`
20. **[Demo]** Update `demos/recipe-generator/Makefile` with new image names
21. **[Demo]** Update `demos/recipe-generator/README.md` with new config format

#### **Phase 6: Documentation**

22. **[Docs]** Update `PROJECT_CONTEXT.md` to clarify agent identity
23. **[Docs]** Update `QUICK_REFERENCE.md` with new config structure
24. **[Docs]** Update `docs/agent-development.md` with role naming conventions
25. **[Docs]** Create migration guide from M3.6 to M3.7 config format
26. **[Docs]** Update M3.6 design doc to reference M3.7 changes
27. **[Docs]** Update all example configs in design docs

#### **Phase 7: Testing**

28. **[Test]** Update all unit tests with new config structure
29. **[Test]** Run recipe demo end-to-end with new naming
30. **[Test]** Verify container names match expected format
31. **[Test]** Verify feedback loop still works (role-based routing)
32. **[Test]** Test controller-worker pattern with new naming

### **3.3. Performance & resource considerations**

**Resource usage**: No change
- Same number of containers
- Same Redis operations
- Shorter container names save negligible space

**Scalability limits**: No change
- Role uniqueness still enforced within instance
- Controller-worker pattern unaffected

**Performance requirements**: No impact
- Config loading slightly simpler (one less field)
- Container name generation trivially faster (shorter string)

### **3.4. Testing strategy**

**Unit tests**:
- `internal/config/config_test.go`: Test role name validation (PascalCase, length, chars)
- `internal/config/config_test.go`: Test agent key becomes role
- `internal/docker/labels_test.go`: Test new container naming functions
- `internal/orchestrator/feedback_loop_test.go`: Test role-based agent lookup

**Integration tests**:
- `demos/recipe-generator/test_workflow.sh`: Update and run with new config
- Verify container names match `holt-{instance}-{role}` pattern
- Verify feedback claims route to correct agent by role

**Manual testing checklist**:
```bash
# 1. Verify config validation
holt up  # Should fail with old config format
# (Update to new format)
holt up  # Should succeed

# 2. Verify container names
docker ps --format "{{.Names}}"
# Expected:
# holt-default-1-Writer
# holt-default-1-Validator
# holt-default-1-Formatter

# 3. Verify workflow
holt forage --goal "Create recipe"
# Should complete successfully with feedback loop

# 4. Verify artefacts
holt hoard
# produced_by_role should show "Writer", "Validator", "Formatter"
```

## **4. Principle compliance check**

### **4.1. YAGNI (You Ain't Gonna Need It)**

**No new dependencies**. This is a simplification that removes complexity, not adds it.

**Removed complexity:**
- One less field in config (`role`)
- Simpler mental model (one identifier instead of two)
- Less validation logic (no role uniqueness check needed)

### **4.2. Auditability**

**Audit trail preserved**. Artefacts still store `produced_by_role`, which now directly matches the agent key in `holt.yml`.

**Improved clarity**: Container names now clearly show which role performed work.

### **4.3. Small, single-purpose components**

**Component boundaries maintained**. This change simplifies configuration but doesn't change component responsibilities.

### **4.4. Security considerations**

**No security impact**. Container naming and labels don't affect security posture.

**Potential benefit**: Clearer container names make security audits easier.

### **4.5. Backward compatibility**

**Breaking change acknowledged**. No backward compatibility provided because:
1. Holt is in early development (Phase 3)
2. Transformation is trivial (rename agent keys, remove `role:` field)
3. Supporting both formats adds unnecessary complexity
4. Clean break forces clarity

**Migration path**: Simple text transformation:
```yaml
# Before
agents:
  my-agent-name:
    role: MyRole
    # ...

# After
agents:
  MyRole:           # Agent key becomes the role
    # role: field removed
    # ... rest unchanged
```

### **4.6. Dependency impact**

**No dependency changes**. All existing dependencies work with new structure.

## **5. Definition of done**

- [ ] All implementation steps from section 3.2 are complete
- [ ] `Role` field removed from `Agent` struct
- [ ] Role name validation implemented (PascalCase convention)
- [ ] Container naming functions updated (`AgentContainerName`, `WorkerContainerName`)
- [ ] CLI launches containers with new naming scheme
- [ ] Orchestrator uses role-based agent lookup
- [ ] Pup config validates name == role consistency
- [ ] Demo `holt.yml` updated with `Writer`, `Validator`, `Formatter` keys
- [ ] Demo images renamed to `holt-{role}-recipe-demo:latest`
- [ ] All tests updated and passing
- [ ] Recipe demo runs successfully end-to-end
- [ ] Container names verified (`holt-{instance}-{role}` format)
- [ ] Feedback loop tested and working
- [ ] Documentation updated (PROJECT_CONTEXT, QUICK_REFERENCE, agent-development)
- [ ] Migration guide created
- [ ] M3.6 design doc updated to reference M3.7 changes

## **6. Error scenarios & edge cases**

### **6.1. Failure modes**

**1. User provides old config format with `role:` field**
- **Cause**: User hasn't migrated config
- **Detection**: Config parsing sees unexpected field (Go will ignore it with current yaml tags)
- **Response**: Add explicit check and error message
- **Recovery**: User removes `role:` field, uses agent key as role

**2. Agent key doesn't match PascalCase convention**
- **Cause**: User uses kebab-case or other format
- **Detection**: `validateRoleName()` checks format
- **Response**: Warning log (not error - allow flexibility)
- **Recovery**: None needed (validation is lenient)

**3. Container name collision with existing container**
- **Cause**: Another tool uses `holt-{instance}-{name}` pattern
- **Detection**: Docker create fails with "name already in use"
- **Response**: Holt up fails with clear error
- **Recovery**: User stops conflicting container or renames instance

**4. Feedback claim can't find agent by role**
- **Cause**: Artefact has `produced_by_role` that doesn't exist in config
- **Detection**: `findAgentByRole()` returns error
- **Response**: Create Failure artefact (already handled in M3.3)
- **Recovery**: None needed (expected failure mode)

### **6.2. Concurrency considerations**

**No new concurrency issues**. Container naming is determined at launch time, no race conditions.

### **6.3. Edge case handling**

**Edge case: Role name with special characters**
- **Behavior**: Validation allows alphanumeric + hyphens
- **Detection**: `validateRoleName()` checks characters
- **Recovery**: Warning logged, allowed to proceed
- **Reason**: Docker accepts these characters in container names

**Edge case: Very long role name**
- **Behavior**: Validation limits to 64 characters
- **Detection**: Length check in `validateRoleName()`
- **Recovery**: Config validation fails with clear error
- **Reason**: Docker has container name length limits

**Edge case: Role name matches reserved words**
- **Behavior**: No reserved words currently
- **Detection**: None
- **Recovery**: None needed
- **Future**: May add reserved word check (e.g., "orchestrator", "redis")

## **7. Open questions & decisions**

**Q1: Should we add reserved role names (e.g., "orchestrator", "redis")?**
- **Decision**: Not for M3.7 - can add later if needed
- **Rationale**: YAGNI - no current conflicts

**Q2: Should validation enforce PascalCase or just warn?**
- **Decision**: WARN only, don't error
- **Rationale**: Allow flexibility, not all users follow Go conventions

**Q3: Should we keep HOLT_AGENT_ROLE env var temporarily?**
- **Decision**: YES - keep for one release to ease transition
- **Rationale**: Allows gradual migration, minimal cost

**Q4: Should image names also follow convention strictly?**
- **Decision**: RECOMMEND but don't enforce
- **Rationale**: Image names are user's choice, convention is helpful but not required

**Q5: Should we version the config to "2.0" for this breaking change?**
- **Decision**: NO - keep version "1.0"
- **Rationale**: Still in Phase 3, haven't declared 1.0 stable yet

## **8. AI agent implementation guidance**

### **8.1. Development approach**

**Step-by-step implementation:**
1. Start with config changes (lowest impact)
2. Update validation and tests
3. Update container naming functions
4. Update CLI and orchestrator
5. Update demo last (validates everything works)

**Test as you go:**
- After each phase, run `make test`
- Before demo update, verify container naming manually
- Run demo as final integration test

### **8.2. Common pitfalls to avoid**

**Pitfall 1: Forgetting to update tests**
- **Symptom**: Tests fail with "field 'Role' not found" or similar
- **Fix**: Update all test configs to use agent key as role
- **Prevention**: Grep for `role:` in test files

**Pitfall 2: Mixing old and new naming**
- **Symptom**: Some containers use old names, some use new
- **Fix**: Ensure ALL container creation uses new functions
- **Prevention**: Global search for `AgentContainerName` usage

**Pitfall 3: Breaking feedback claim routing**
- **Symptom**: Feedback claims don't find the agent
- **Fix**: Verify `findAgentByRole()` uses agent key correctly
- **Prevention**: Test feedback loop explicitly

**Pitfall 4: Not updating environment variables consistently**
- **Symptom**: Pup receives different values for HOLT_AGENT_NAME and HOLT_AGENT_ROLE
- **Fix**: Ensure both env vars set to same value (the role)
- **Prevention**: Add validation in pup config

### **8.3. Integration checklist**

**Pre-implementation:**
- [ ] All M3.6 features complete and tested
- [ ] Recipe demo working with old config format
- [ ] Tests passing baseline

**During implementation:**
- [ ] Config structs updated before CLI
- [ ] Container naming updated before orchestrator
- [ ] Tests updated alongside code changes
- [ ] Demo updated last

**Post-implementation:**
- [ ] Run full test suite
- [ ] Run recipe demo end-to-end
- [ ] Verify container names with `docker ps`
- [ ] Check artefact `produced_by_role` values
- [ ] Test feedback loop explicitly
- [ ] Test controller-worker naming (if available)

## **9. Operational readiness**

### **9.1. Monitoring and observability**

**No new metrics needed**. Existing logs and metrics work with new naming.

**Improved observability**:
- Container names more clearly indicate agent role
- Docker logs easier to identify by role
- `docker ps` output more readable

### **9.2. Rollback and disaster recovery**

**Rollback procedure**:
1. Revert code to M3.6
2. Update `holt.yml` to old format (add `role:` fields, use arbitrary keys)
3. Rebuild and restart

**No data migration needed**: Blackboard state unaffected (artefacts reference roles, which are stable)

### **9.3. Documentation and training**

**Documentation updates required**:
- [ ] PROJECT_CONTEXT.md - Core concepts section
- [ ] QUICK_REFERENCE.md - Config structure
- [ ] docs/agent-development.md - Role naming conventions
- [ ] All design docs with example configs

**Migration guide required**:
```markdown
# Migrating from M3.6 to M3.7

1. In holt.yml, rename each agent key to match its role
2. Remove the `role:` field from each agent
3. Update image names to follow `holt-{role}-{purpose}:latest` convention (optional but recommended)
4. Rebuild and restart

Example:
```yaml
# Before (M3.6)
agents:
  my-coder:
    role: CodeWriter
    image: my-coder:latest

# After (M3.7)
agents:
  CodeWriter:
    image: holt-codewriter-demo:latest
```
```

## **10. Self-validation checklist**

### **Before starting implementation:**

- [x] I understand this is an architectural simplification
- [x] All design decisions (section 3.1) are justified
- [x] Breaking change is acceptable (no backward compatibility needed)
- [x] User has confirmed all answers to questions

### **During implementation:**

- [ ] Following implementation steps in order (config → naming → demo)
- [ ] Updating tests alongside code changes
- [ ] Verifying container naming at each step
- [ ] Testing feedback loop routing

### **Before submission:**

- [ ] All items in Definition of Done (section 5) are complete
- [ ] Recipe demo runs successfully with new config
- [ ] Container names verified with `docker ps`
- [ ] Documentation updated and accurate
- [ ] Migration guide created and tested

---

## **Migration Guide**

### **Quick Start**

For existing Holt configs, the migration is simple:

**1. Update agent keys:**
```yaml
# Before
agents:
  recipe-drafter:    # Arbitrary name
    role: Writer     # Actual role

# After
agents:
  Writer:            # Key IS the role
    # No role: field
```

**2. Remove `role:` field from all agents**

**3. Optionally rename images:**
```yaml
# Before
image: recipe-drafter-agent:latest

# After
image: holt-writer-recipe-demo:latest
```

**4. Rebuild and restart:**
```bash
make build-all
holt down
holt up
```

### **Expected Changes**

**Container names:**
- Before: `holt-agent-default-1-recipe-drafter`
- After: `holt-default-1-Writer`

**Artefacts:**
- No change: `produced_by_role: "Writer"` (already used role, not name)

**Feedback routing:**
- No change: Works the same way (looks up agent by role = agent key)
