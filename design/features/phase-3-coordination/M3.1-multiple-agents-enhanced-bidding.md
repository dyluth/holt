# **Feature design: Multiple Agents & Enhanced Bidding System**

**Purpose**: Enable multiple agents to bid on claims with full consensus model and deterministic grant selection
**Scope**: Phase 3 Coordination - Milestone 1
**Estimated tokens**: ~4,500 tokens
**Read when**: Implementing multi-agent coordination, consensus bidding, agent registry

Associated phase: **Coordination (Phase 3)**
Status: **Draft**

***Template purpose:*** This document is a blueprint for M3.1, an implementable milestone that establishes the foundation for multi-agent workflows. It provides an unambiguous specification for implementing the full consensus bidding model with multiple agents working simultaneously.

## **1. The 'why': goal and success criteria**

### **1.1. Goal statement**

Enable multiple agents (2-3 different types) to bid on claims simultaneously with full consensus model, supporting all four bid types (review, claim, exclusive, ignore) and deterministic grant selection.

### **1.2. User story**

As a Holt user, I want to define multiple specialized agents in my holt.yml (e.g., a reviewer agent, a coder agent, and a test agent) so that when I run `holt forage --goal "implement feature X"`, all agents can evaluate the goal and bid appropriately, with the orchestrator waiting for all bids before granting the claim to the most appropriate agent. This ensures that every agent has an opportunity to participate in the workflow and that the system makes deterministic, reproducible decisions about which agent should handle each piece of work.

### **1.3. Success criteria**

1. **Multi-agent startup**: `holt up` with 3 agents defined in holt.yml successfully starts all containers in parallel and validates health checks before reporting success
2. **Full consensus bidding**: `holt forage --goal "test"` triggers all 3 agents to evaluate and submit bids (exclusive, review, ignore), and the orchestrator waits for all 3 bids before proceeding
3. **Deterministic grant selection**: When multiple agents bid "exclusive", the orchestrator grants to the alphabetically-first agent name consistently across runs
4. **Complete audit trail**: `holt hoard` shows all bids submitted (with agent names and bid types) and the grant decision with clear reasoning in logs
5. **Backward compatibility**: All Phase 2 tests continue to pass with single-agent configurations (consensus is immediate with 1 agent)
6. **Invalid bid handling**: An agent submitting an invalid bid type is treated as "ignore" with a warning logged, and consensus continues without blocking

### **1.4. Non-goals**

- **Review phase execution** (M3.2): While agents can submit "review" bids, the orchestrator will not execute review grants in M3.1
- **Parallel phase execution** (M3.2): While agents can submit "claim" bids, parallel work coordination is deferred
- **Controller-worker pattern** (M3.3): `replicas > 1` scaling with bidder-only/execute-only modes
- **LLM-based bidding** (Phase 4): Dynamic bid type selection based on LLM evaluation
- **Bid timeouts** (Phase 4): V1 waits indefinitely for all agent bids
- **Dynamic agent registration** (Future): Agents must be defined in holt.yml at startup

### **1.5. Known Limitations & Implementation Notes**

#### **Hardcoded Loop Prevention Heuristic**

**Issue:** Configuration-based bidding strategies don't consider artefact context, causing agents to bid on their own outputs. For example, an agent with `bidding_strategy: "exclusive"` would bid exclusive on every artefact, including CodeCommit artefacts it just produced, creating infinite execution loops.

**Current Solution:** Hardcoded heuristic in `internal/pup/engine.go:handleClaimEvent()` - agents automatically bid "ignore" on artefacts where `artefact.ProducedByRole == agent.AgentRole`. This prevents agents from bidding on their own outputs.

**Implementation:**
```go
// HEURISTIC: If this agent's role produced the artefact, ignore the claim to prevent loops.
if targetArtefact.ProducedByRole == e.config.AgentRole {
    log.Printf("[INFO] Ignoring claim %s for self-produced artefact (role: %s)", claim.ID, e.config.AgentRole)
    bidType = blackboard.BidTypeIgnore
}
```

**Limitations of this heuristic:**
- Prevents legitimate cross-agent workflows where agents should bid on other agents' outputs (e.g., reviewer-agent bidding "review" on coder-agent's CodeCommit)
- Doesn't support multi-stage pipelines where the same role appears multiple times
- No consideration of artefact type, structural type, or workflow stage
- Role-based matching is too coarse-grained for complex workflows

**Future Resolution:** This heuristic is intentionally simplistic for M3.1 scope. Phase 4 LLM-based bidding will intelligently evaluate whether to bid based on:
- Artefact type, content, structural type, and producer role
- Agent's capabilities, role, and current workflow context
- Explicit instructions in agent prompts (e.g., "review all CodeCommit artefacts from other agents")
- Workflow stage and phase-specific logic
- Historical context (e.g., "don't bid on artefacts I've already reviewed")

**M3.2 Extension:** When implementing review phase execution, this heuristic will need refinement to allow reviewer agents to bid "review" on artefacts produced by other roles while still preventing execution loops.

## **2. The 'what': component impact analysis**

### **2.1. Blackboard changes**

**New/modified data structures:**
- **No schema changes required**: The existing Claim and Bid data structures already support multiple agents and all bid types
- **Agent registry tracking**: No new Redis keys needed - agent list comes from holt.yml loaded at startup

**New Pub/Sub channels:**
- No new channels required

**Enhanced logging events:**
- Bid arrival events (for observability)
- Consensus progress events (periodic waiting logs)
- Grant decision events (including tie-breaking rationale)

### **2.2. Orchestrator changes**

**New/modified logic:**

1. **Agent Registry Management**:
   - Load complete agent list from holt.yml at startup
   - Store in-memory map of agent names for consensus validation
   - Log agent count on startup: "Orchestrator starting with {count} agents: [{names}]"

2. **Full Consensus Bidding Model** (Major Enhancement):
   ```go
   // For each claim:
   // 1. Create claim, publish to claim_events
   // 2. Initialize empty bid tracking for this claim
   // 3. For each incoming bid:
   //    - Validate bid type (review/claim/exclusive/ignore)
   //    - If invalid: treat as "ignore" + log warning
   //    - Store in Redis: holt:{instance}:claim:{uuid}:bids
   //    - Log: "Received {bid_type} bid from {agent_name} for claim {id}"
   // 4. Check consensus:
   //    - Get all bids from Redis
   //    - Compare count against agent registry size
   //    - If missing bids: log "Waiting for bids from: [{missing}] (waited {duration})"
   //    - If complete: log "Consensus achieved: received {count}/{total} bids (took {duration}ms)"
   // 5. Process grants (M3.1: exclusive only)
   ```

3. **Deterministic Exclusive Grant Selection**:
   ```go
   // When multiple agents bid "exclusive":
   // 1. Collect all exclusive bidders
   // 2. Sort alphabetically by agent name (strings.Sort)
   // 3. Grant to first in sorted list
   // 4. Log: "Granted exclusive to {winner} (selected from {count} exclusive bidders: [{all_bidders}])"
   ```

4. **Enhanced Bid Logging**:
   - Per-bid logging: Each bid logged as it arrives
   - Periodic waiting logs: Every 5 seconds while waiting for consensus
   - Consensus achievement log: Duration and bid summary
   - Grant decision log: Winner and rationale

5. **Invalid Bid Handling**:
   - Detect bids not matching: "review", "claim", "exclusive", "ignore"
   - Treat as "ignore" bid (safe default)
   - Log warning: "Agent {name} submitted invalid bid type '{type}' for claim {id}, treating as 'ignore'"
   - Continue consensus (don't block workflow)

6. **Grant Phase Logic** (M3.1 Scope):
   - Only process exclusive phase grants
   - Review and parallel bids are collected but not granted
   - Status transitions: `pending_review` â†’ `pending_exclusive` (skip parallel)
   - Log: "Skipping review/parallel phases (M3.1 limitation)"

**New/modified configurations (holt.yml):**
```yaml
agents:
  coder-agent:
    role: "Coder"
    image: "example-coder-agent:latest"
    command: ["/app/run.sh"]
    bidding_strategy: "exclusive"  # NEW REQUIRED FIELD
    workspace:
      mode: rw

  reviewer-agent:
    role: "Reviewer"
    image: "example-reviewer-agent:latest"
    command: ["/app/run.sh"]
    bidding_strategy: "review"  # NEW REQUIRED FIELD
    workspace:
      mode: ro

  test-agent:
    role: "Tester"
    image: "example-test-agent:latest"
    command: ["/app/run.sh"]
    bidding_strategy: "ignore"  # NEW REQUIRED FIELD
    workspace:
      mode: ro
```

**Field validation:**
- `bidding_strategy` is **required** for all agents
- Must be one of: "review", "claim", "exclusive", "ignore"
- Config validation fails at startup if missing or invalid

### **2.3. Agent pup changes**

**New/modified logic:**

1. **Bidding Strategy Configuration**:
   - Read `HOLT_BIDDING_STRATEGY` environment variable at startup
   - Validate value is one of: review, claim, exclusive, ignore
   - Fail-fast if missing or invalid (clear error message)
   - Store in pup config struct

2. **Enhanced Bid Submission**:
   ```go
   // In Claim Watcher goroutine:
   // 1. Receive claim notification
   // 2. Fetch claim details
   // 3. Submit bid using configured strategy:
   bidType := e.config.BiddingStrategy  // from env var, not hardcoded
   err := e.bbClient.SubmitBid(claim.ID, e.config.AgentName, bidType)
   // 4. Log: "Submitted {bidType} bid for claim {id}"
   ```

3. **Grant Notification Handling** (No Changes):
   - Existing grant notification logic works unchanged
   - Only responds to exclusive grants in M3.1
   - Review/parallel grants will be ignored (not published by orchestrator yet)

**Changes to the tool execution contract (stdin/stdout):**
- No changes to stdin/stdout JSON schemas
- The pup's execution behavior is unchanged
- `claim_type` field in stdin will only be "exclusive" in M3.1

### **2.4. CLI changes**

**New/modified commands:**

1. **Enhanced `holt up`**:
   ```
   Usage: holt up [--name <instance>] [--force]

   Behavior changes:
   - Validates all agent configurations before starting any containers
   - Launches all agent containers in parallel (not sequential)
   - Waits for health checks from all agents before reporting success
   - Enhanced output showing agent count and names
   - Timeout: 30 seconds for full system readiness
   - Rollback: If any agent fails health check, stops all containers
   ```

2. **Enhanced Output**:
   ```
   âœ“ Validated 3 agent image(s)
   âœ“ Started orchestrator: holt-orchestrator-my-instance
   âœ“ Started agent containers (parallel):
     â€¢ holt-agent-my-instance-coder-agent (running, healthy)
     â€¢ holt-agent-my-instance-reviewer-agent (running, healthy)
     â€¢ holt-agent-my-instance-test-agent (running, healthy)
   âœ“ Instance 'my-instance' started successfully (3 agents ready)
   ```

3. **Agent Container Orchestration**:
   - For each agent in holt.yml:
     - Inject environment variables:
       - Existing: HOLT_INSTANCE_NAME, HOLT_AGENT_NAME, REDIS_URL, HOLT_AGENT_ROLE
       - New: HOLT_BIDDING_STRATEGY (from holt.yml)
     - Start container in parallel (goroutine)
     - Track in WaitGroup
   - Wait for all containers to start
   - Validate health checks: GET /healthz for each agent
   - Report success only when all healthy

**Changes to user output:**
- Show agent count prominently
- List all agent names with status
- Clear error messages if agent fails to start or become healthy

## **3. The 'how': implementation & testing plan**

### **3.1. Key design decisions & risks**

**Critical Design Decisions:**

1. **Deterministic Tie-Breaking (Alphabetical Sorting)**:
   - **Decision**: When multiple agents bid "exclusive", grant to alphabetically-first agent name
   - **Rationale**: Ensures reproducible workflows, eliminates race conditions, simplifies debugging
   - **Alternative considered**: First-bid-wins (temporal order) - rejected due to non-determinism in distributed systems
   - **Implementation**: `sort.Strings(exclusiveBidders); winner := exclusiveBidders[0]`

2. **Configuration-Based Bidding Strategy**:
   - **Decision**: Bidding strategy declared in holt.yml, not LLM-driven
   - **Rationale**: Keeps M3.1 deterministic, testable, focused on orchestrator consensus logic
   - **Trade-off**: Less flexible than LLM-based decisions, but enables reliable multi-agent testing
   - **Future path**: LLM-based strategies can be added in Phase 4 as an enhancement

3. **Parallel Container Launch**:
   - **Decision**: Start all agent containers in parallel with health check validation
   - **Rationale**: Improves startup time, production-ready behavior, validates system readiness
   - **Complexity**: Requires goroutine coordination, proper error handling, rollback on failure
   - **Risk mitigation**: Use sync.WaitGroup, clear timeout (30s), comprehensive error logging

4. **Invalid Bid Handling (Treat as Ignore)**:
   - **Decision**: Invalid bids default to "ignore" with warning, don't block consensus
   - **Rationale**: Fault-tolerant system, one agent's misconfiguration shouldn't halt workflow
   - **Alternative considered**: Fail consensus - rejected as too brittle
   - **Observability**: Clear warning logs identify misconfigured agents

5. **Phased Execution Deferral**:
   - **Decision**: Collect review/parallel bids but don't grant (defer to M3.2)
   - **Rationale**: Focuses M3.1 on consensus mechanics, incremental complexity
   - **User impact**: Agents can bid "review" but won't execute until M3.2
   - **Documentation**: Clearly document M3.1 limitation in logs and docs

**Risks:**

1. **Indefinite Consensus Wait** (V1 Limitation):
   - **Risk**: If an agent crashes before bidding, orchestrator waits forever
   - **Mitigation**: Document as known limitation, defer bid timeouts to Phase 4
   - **Workaround**: Users can restart crashed agents or manually intervene
   - **Monitoring**: Periodic waiting logs help identify stuck claims

2. **Health Check Race Conditions**:
   - **Risk**: Agent container starts but health endpoint not ready yet
   - **Mitigation**: Retry health checks with exponential backoff (5 attempts over 10s)
   - **Timeout**: 30s total allows ample time for slow container startups

3. **Consensus Performance with Many Agents**:
   - **Risk**: Bid collection latency increases linearly with agent count
   - **Mitigation**: Redis Pub/Sub is fast, expect <100ms even with 10 agents
   - **Benchmark**: Test with 10 agents to validate performance

### **3.2. Implementation steps**

**Phase 1: Configuration & Validation**

1. **[Config]** Add `bidding_strategy` field to Agent struct in `internal/config/config.go`
2. **[Config]** Implement validation for `bidding_strategy` (required, enum check)
3. **[Config]** Update `config_test.go` with bidding_strategy validation tests
4. **[Pup]** Add `HOLT_BIDDING_STRATEGY` to pup config loading in `internal/pup/config.go`
5. **[Pup]** Implement fail-fast validation for missing/invalid bidding strategy

**Phase 2: Orchestrator Consensus Logic**

6. **[Orchestrator]** Create `internal/orchestrator/consensus.go` with full consensus model:
   - `WaitForConsensus(claimID string) (map[string]string, error)` - returns agentâ†’bidType map
   - Agent registry management (load from holt.yml)
   - Bid collection with validation
   - Periodic waiting logs (every 5s)
   - Consensus achievement detection
7. **[Orchestrator]** Enhance `internal/orchestrator/engine.go` claim lifecycle:
   - After creating claim, call `WaitForConsensus()`
   - Log each bid as it arrives
   - Log consensus achievement with duration
8. **[Orchestrator]** Implement deterministic grant selection in `internal/orchestrator/granting.go`:
   - `SelectExclusiveWinner(bidders []string) string` - alphabetical sorting
   - Log grant decision with tie-breaking rationale
9. **[Orchestrator]** Add invalid bid handling:
   - Detect invalid bid types in consensus logic
   - Treat as "ignore" with warning log
   - Update bid map with "ignore"

**Phase 3: Agent Pup Bidding**

10. **[Pup]** Update `internal/pup/watcher.go` bid submission:
    - Remove hardcoded `bidType := "exclusive"`
    - Use `e.config.BiddingStrategy` from environment
    - Add logging: "Submitting {bidType} bid for claim {id}"
11. **[Pup]** Update pup tests to use configurable bidding strategy

**Phase 4: CLI Multi-Agent Launch**

12. **[CLI]** Enhance `cmd/holt/commands/up.go` for parallel agent launch:
    - Create `launchAgentContainersParallel()` function
    - Use goroutines + sync.WaitGroup for parallel start
    - Inject `HOLT_BIDDING_STRATEGY` environment variable
13. **[CLI]** Implement health check validation:
    - Create `validateAllAgentsHealthy()` function
    - Retry logic with exponential backoff (5 attempts, 10s)
    - Timeout: 30s total for all agents
    - Rollback on failure: stop all containers
14. **[CLI]** Update `holt up` output:
    - Show agent count and names
    - Report health status per agent
    - Clear success/failure messages

**Phase 5: Example Agents**

15. **[Agents]** Create `agents/example-reviewer-agent/`:
    - Dockerfile with pup entrypoint
    - `run.sh` that always outputs Review artefact with `{}`
    - holt.yml snippet with `bidding_strategy: review`
16. **[Agents]** Update `agents/example-git-agent/` to use `bidding_strategy: exclusive` in holt.yml
17. **[Agents]** Create `agents/example-test-agent/`:
    - Dockerfile with pup entrypoint
    - `run.sh` that always bids ignore (outputs nothing)
    - holt.yml snippet with `bidding_strategy: ignore`

**Phase 6: Testing & Validation**

18. **[Tests]** Create `cmd/holt/commands/e2e_multi_agent_test.go`:
    - Test 3-agent startup and health checks
    - Test full consensus with all bid types
    - Test deterministic tie-breaking (2 exclusive bidders)
    - Test invalid bid handling
    - Test backward compatibility (single agent)
19. **[Tests]** Create `internal/orchestrator/consensus_test.go`:
    - Unit tests for consensus logic
    - Unit tests for alphabetical tie-breaking
    - Unit tests for invalid bid handling
20. **[Tests]** Run full Phase 2 test suite to validate backward compatibility

**Phase 7: Documentation & Completion**

21. **[Docs]** Update `README.md` with Phase 3 M3.1 status
22. **[Docs]** Update `docs/agent-development.md` with bidding_strategy field
23. **[Docs]** Create example holt.yml with multiple agents
24. **[Docs]** Document M3.1 limitations (review/parallel not granted)

### **3.3. Performance & resource considerations**

**Resource usage:**

- **Redis**: Minimal additional load - bids stored as small hashes, Pub/Sub is efficient
- **Memory**: Orchestrator stores agent registry in memory (~1KB per agent, negligible)
- **CPU**: Bid validation and consensus checking are O(n) operations where n=agent count (fast for n<100)
- **Network**: Additional Pub/Sub messages scale linearly with agent count (still <1KB per bid)

**Scalability limits:**

- **Agent count**: Tested with 10 agents, expect good performance up to 50 agents
- **Consensus wait time**: Increases with agent count, but Redis Pub/Sub keeps it fast (<100ms per bid)
- **Container startup**: Parallel launch keeps startup time reasonable even with 10+ agents

**Performance requirements:**

- **Consensus collection**: <500ms for 5 agents (includes bid submission + collection)
- **Health check validation**: <30s for 10 agents (includes retries)
- **Startup time**: `holt up` completes in <15s with 5 agents
- **No regression**: Phase 2 performance metrics remain unchanged with single agent

### **3.4. Testing strategy**

**Unit tests:**

1. **Config validation**:
   - `internal/config/config_test.go`: Validate bidding_strategy field
   - Test missing bidding_strategy (should fail)
   - Test invalid bidding_strategy (should fail)
   - Test valid values (review, claim, exclusive, ignore)

2. **Consensus logic**:
   - `internal/orchestrator/consensus_test.go`: Mock Redis, test consensus detection
   - Test full consensus (all agents bid)
   - Test partial consensus (missing bids)
   - Test invalid bid handling (treat as ignore)
   - Test bid logging

3. **Grant selection**:
   - `internal/orchestrator/granting_test.go`: Test alphabetical tie-breaking
   - Test single exclusive bidder (no tie-breaking)
   - Test multiple exclusive bidders (alphabetical order)
   - Test empty exclusive bidders (no grant)

**Integration tests:**

1. **Multi-agent consensus**:
   - `internal/orchestrator/orchestrator_integration_test.go`: Real Redis + orchestrator
   - Create claim, submit 3 bids, verify consensus
   - Verify all bids stored correctly
   - Verify grant to correct agent

2. **Agent bidding**:
   - `internal/pup/pup_integration_test.go`: Real Redis + pup
   - Pup receives claim, submits configured bid type
   - Verify bid appears in Redis
   - Test all bid types (review, claim, exclusive, ignore)

3. **CLI agent launch**:
   - `cmd/holt/commands/up_integration_test.go`: Docker + Redis
   - Launch 3 agents in parallel
   - Verify all containers running
   - Verify all health checks pass

**E2E tests:**

1. **Three-agent happy path** (`cmd/holt/commands/e2e_multi_agent_test.go`):
   ```
   Scenario: 3 agents (coder=exclusive, reviewer=review, tester=ignore)
   Steps:
     1. holt up (3 agents)
     2. holt forage --goal "test"
     3. Wait for consensus (all 3 bids)
     4. Verify coder-agent wins (exclusive grant)
     5. Verify coder-agent executes and creates CodeCommit artefact
     6. Verify audit trail shows all 3 bids + grant decision
   ```

2. **Tie-breaking test**:
   ```
   Scenario: 2 agents both bid exclusive (alpha-agent, beta-agent)
   Steps:
     1. Both agents bid exclusive
     2. Verify orchestrator grants to alpha-agent (alphabetically first)
     3. Verify consistent across multiple runs (determinism)
   ```

3. **Invalid bid test**:
   ```
   Scenario: One agent submits invalid bid type "foobar"
   Steps:
     1. Configure agent with invalid bid (manual Redis write)
     2. Verify orchestrator treats as ignore
     3. Verify warning logged
     4. Verify consensus continues
   ```

4. **Backward compatibility test**:
   ```
   Scenario: Single agent (Phase 2 configuration)
   Steps:
     1. holt up with 1 agent
     2. holt forage --goal "test"
     3. Verify immediate consensus (no waiting)
     4. Verify workflow completes normally
     5. All Phase 2 tests pass
   ```

## **4. Principle compliance check**

### **4.1. YAGNI (You Ain't Gonna Need It)**

**No new third-party dependencies introduced.**

All functionality is implemented using existing libraries:
- Go standard library for sorting, concurrency
- Existing Redis client for bid storage
- Existing Docker SDK for container management

**Justification**: The consensus model and multi-agent coordination are core requirements for Phase 3, not speculative features. The configuration-based bidding strategy is the simplest approach that satisfies the requirement.

### **4.2. Auditability**

**New artefacts created by this feature:**
- No new artefact types (still using existing GoalDefined, CodeCommit, etc.)
- Enhanced bid tracking in Redis provides complete audit trail

**Immutable audit trail preserved:**
- All bids stored immutably in `holt:{instance}:claim:{uuid}:bids` hash
- Orchestrator logs capture complete decision history
- Grant decisions logged with tie-breaking rationale
- Invalid bids logged with warnings

**State changes captured:**
- Bid arrival: Logged with timestamp, agent name, bid type
- Consensus achievement: Logged with duration, bid summary
- Grant decision: Logged with winner, all bidders, selection criteria
- Invalid bids: Logged with warning, treated as ignore

### **4.3. Small, single-purpose components**

**Component responsibilities remain clear:**

- **Orchestrator**: Consensus coordination, grant selection (enhanced but focused)
- **Agent Pup**: Bidding with configured strategy (simple enhancement)
- **CLI**: Multi-agent lifecycle management (natural extension)

**No tight coupling introduced:**
- Components still communicate only via blackboard (Redis)
- Agent pup doesn't know about other agents
- Orchestrator doesn't embed agent-specific logic
- Configuration remains declarative (holt.yml)

**Responsibilities preserved:**
- Orchestrator remains "traffic cop" (no domain logic)
- Agent pups remain autonomous (independent bidding)
- CLI remains user interface layer (no orchestration logic)

### **4.4. Security considerations**

**Security implications:**

1. **Container isolation**: Multiple agents run in separate containers (proper isolation maintained)
2. **Workspace access**: Each agent's workspace mount mode (ro/rw) enforced per holt.yml
3. **Resource limits**: Agent resource constraints (CPU, memory) respected from holt.yml
4. **No new attack surfaces**: All communication via existing Redis channels (no new network exposure)

**Credentials and secrets:**
- Environment variables (including HOLT_BIDDING_STRATEGY) passed securely via Docker
- No secrets in logs or bidding strategy configuration
- Existing environment variable injection mechanism unchanged

**Container privileges:**
- All agents continue to run as non-root users (UID 1000)
- No new privilege requirements
- Principle of least privilege maintained

**Network communications:**
- All Redis communication on internal Docker network
- No external network access required for bidding
- Health check endpoints remain localhost-bound

### **4.5. Backward compatibility**

**Changes to existing APIs/data structures:**

1. **holt.yml schema change** (additive):
   - New required field: `bidding_strategy` for each agent
   - **Breaking change**: Existing holt.yml files must add this field
   - **Migration**: Simple one-line addition per agent
   - **Validation**: Clear error message if field missing

2. **Environment variables** (additive):
   - New: `HOLT_BIDDING_STRATEGY` passed to pup
   - **Non-breaking**: Existing env vars unchanged
   - **Backward compat**: Single-agent configs still work with new field

3. **Redis data structures** (unchanged):
   - Bid storage schema identical
   - Claim schema identical
   - No data migration required

**Existing workflows preserved:**

- Single-agent workflows work unchanged (consensus with n=1 is immediate)
- Phase 2 E2E tests must pass without modification
- CLI commands unchanged (holt up, forage, down, etc.)
- Agent pup behavior unchanged for granted claims

**Deprecation path:**

- None required - this is an additive feature
- Future: Could make bidding_strategy optional with default value (not in M3.1)

### **4.6. Dependency impact**

**Redis usage changes:**
- More bid entries per claim (n bids instead of 1)
- Orchestrator queries bid hash more frequently (per-bid arrival)
- **Impact**: Minimal - Redis easily handles this load

**Docker requirements:**
- Parallel container launch requires proper Docker SDK usage
- Health check endpoints already implemented (no new requirement)
- **Impact**: None - using existing Docker API features

**Go version:**
- No new Go language features required
- Continue using Go 1.23
- **Impact**: None

**Build dependencies:**
- No new build tools or dependencies
- Makefile targets unchanged
- **Impact**: None

**CI/CD pipeline:**
- E2E tests now launch 3 agents (more containers)
- May increase CI resource usage (3x containers)
- **Impact**: Monitor CI run times, may need resource adjustment

## **5. Definition of done**

- [ ] All implementation steps from section 3.2 are complete
- [ ] All tests defined in section 3.4 are implemented and passing
- [ ] Performance requirements from section 3.3 are met and verified
- [ ] Overall test coverage has not decreased (maintain 90%+ for new packages)
- [ ] The Makefile has been updated with any new build, test, or run commands
- [ ] All new CLI commands, flags, and holt.yml fields are documented
- [ ] The developer onboarding time (git clone to running holt up) remains under 10 minutes
- [ ] All TODOs from the specification documents relevant to this milestone have been resolved
- [ ] All failure modes identified in section 6.1 have been implemented and tested
- [ ] Concurrency considerations from section 6.2 have been addressed
- [ ] All open questions from section 7 have been resolved or documented as future work
- [ ] AI agent implementation guidance has been followed and integration checklist completed
- [ ] Security considerations from section 4.4 have been addressed and validated
- [ ] Backward compatibility requirements from section 4.5 are satisfied (Phase 2 tests pass)
- [ ] Dependency impact analysis from section 4.6 has been completed and approved
- [ ] Operational readiness checklist from section 9 is fully satisfied

## **6. Error scenarios & edge cases**

### **6.1. Failure modes**

**Orchestrator failures:**

1. **Agent fails to bid (container crash before bidding)**:
   - **Behavior**: Orchestrator waits indefinitely (V1 limitation)
   - **Detection**: Periodic waiting logs show missing agent
   - **Recovery**: Manual intervention (restart agent or cancel workflow)
   - **Logging**: "Waiting for bids from: [crashed-agent] (waited 30s)" every 5s

2. **Redis unavailable during bid collection**:
   - **Behavior**: Orchestrator health check fails, exits
   - **Detection**: Health endpoint returns 503
   - **Recovery**: Container orchestration restarts orchestrator
   - **Logging**: "Failed to read bids from Redis: {error}"

3. **Invalid bid type submitted**:
   - **Behavior**: Treated as "ignore" bid, consensus continues
   - **Detection**: Automatic during bid validation
   - **Recovery**: Automatic (safe default)
   - **Logging**: "Agent {name} submitted invalid bid type '{type}', treating as 'ignore'"

**Agent pup failures:**

4. **Missing HOLT_BIDDING_STRATEGY environment variable**:
   - **Behavior**: Pup exits with error on startup (fail-fast)
   - **Detection**: Immediate at pup initialization
   - **Recovery**: Fix holt.yml, restart with `holt down && holt up`
   - **Logging**: "HOLT_BIDDING_STRATEGY environment variable is required"

5. **Invalid bidding_strategy value in holt.yml**:
   - **Behavior**: Config validation fails during `holt up` (fail-fast)
   - **Detection**: Config parsing stage
   - **Recovery**: Fix holt.yml value, retry `holt up`
   - **Logging**: "Invalid bidding_strategy 'foobar' for agent 'my-agent', must be one of: review, claim, exclusive, ignore"

6. **Agent container fails health check**:
   - **Behavior**: `holt up` fails, rolls back all containers
   - **Detection**: Health check retry exhaustion (5 attempts, 10s)
   - **Recovery**: Check agent logs, fix configuration, retry
   - **Logging**: "Agent {name} failed health check after 5 retries, rolling back"

**CLI failures:**

7. **Parallel container launch failure (one agent fails to start)**:
   - **Behavior**: Stop all agents, rollback, `holt up` fails
   - **Detection**: Docker API error during container creation
   - **Recovery**: Check Docker logs, fix issue, retry
   - **Logging**: "Failed to start agent {name}: {error}, rolling back all containers"

8. **Health check timeout (agents don't become healthy within 30s)**:
   - **Behavior**: `holt up` fails with timeout error
   - **Detection**: 30s total timeout exceeded
   - **Recovery**: Check agent logs, increase timeout if needed, retry
   - **Logging**: "Timed out waiting for agents to become healthy after 30s"

### **6.2. Concurrency considerations**

**Race condition analysis:**

1. **Multiple bids from same agent**:
   - **Possibility**: Agent pup submits duplicate bids due to retry logic
   - **Protection**: Redis HSET is idempotent (last write wins)
   - **Impact**: No corruption, last bid value stored
   - **Logging**: Could log warning if duplicate detected

2. **Consensus check race**:
   - **Possibility**: Orchestrator checks consensus while bid is being written
   - **Protection**: Redis atomicity ensures bid is fully written or not present
   - **Impact**: Worst case: orchestrator checks again in next iteration
   - **Performance**: Negligible (sub-millisecond delay)

3. **Parallel container start race**:
   - **Possibility**: Multiple goroutines create containers simultaneously
   - **Protection**: Docker SDK is thread-safe, container names are unique
   - **Impact**: No collision, each container created independently
   - **Synchronization**: sync.WaitGroup ensures all complete before proceeding

4. **Grant notification race**:
   - **Possibility**: Orchestrator publishes grant while pup is restarting
   - **Protection**: Agent pup polls claim status (doesn't rely solely on Pub/Sub)
   - **Impact**: Grant delivered via polling fallback
   - **Recovery**: Automatic (existing poll mechanism)

5. **Agent registry mutation during runtime**:
   - **Possibility**: None - agent registry loaded once at orchestrator startup
   - **Protection**: Immutable after load (no runtime modifications)
   - **Impact**: New agents require orchestrator restart (documented limitation)

**Controller-worker pattern** (deferred to M3.3):
- No concurrency concerns in M3.1 (replicas=1 only)
- Standard mode only (single container per agent)

### **6.3. Edge case handling**

**Edge case: All agents bid "ignore"**:
- **Behavior**: Claim remains in `pending_exclusive` status (valid end state)
- **Detection**: Consensus achieved, but no exclusive bids
- **Recovery**: User can manually inspect and decide next steps
- **Logging**: "Consensus achieved but no exclusive bids for claim {id}, claim remains pending"

**Edge case: No agents defined in holt.yml**:
- **Behavior**: Config validation fails, `holt up` fails
- **Detection**: Config parsing stage
- **Recovery**: Add at least one agent to holt.yml
- **Logging**: "No agents defined in holt.yml, at least one agent is required"

**Edge case: All agents bid "review" (no exclusive bids)**:
- **Behavior**: Same as all ignore (claim stays pending)
- **M3.1 limitation**: Review bids not processed yet
- **Recovery**: Wait for M3.2 or adjust agent configuration
- **Logging**: "No exclusive bids for claim {id}, review/parallel bids not processed in M3.1"

**Edge case: Agent name collision in holt.yml**:
- **Behavior**: Config validation fails (YAML parser detects duplicate keys)
- **Detection**: Config parsing stage
- **Recovery**: Rename agents to be unique
- **Logging**: "Duplicate agent name detected in holt.yml"

**Edge case: 100 agents**:
- **Behavior**: Should work, but slower consensus collection
- **Performance**: Test with 10 agents, document recommended maximum
- **Scalability**: Redis handles this easily, main bottleneck is network latency
- **Recommendation**: Keep agent count under 20 for optimal performance (document in README)

## **7. Open questions & decisions**

**All questions resolved. Ready for implementation.**

The following decisions have been made:

1. âœ… **Bidding strategy**: Configuration-based (holt.yml field)
2. âœ… **Tie-breaking**: Alphabetical sorting by agent name (deterministic)
3. âœ… **Invalid bids**: Treat as "ignore" with warning
4. âœ… **Container launch**: Parallel with health check validation
5. âœ… **Consensus wait**: Indefinite (V1 limitation, no timeouts)
6. âœ… **Grant phases**: Only exclusive in M3.1, review/parallel deferred
7. âœ… **Example agents**: reviewer (review), coder (exclusive), tester (ignore)

## **8. AI agent implementation guidance**

### **8.1. Development approach**

**Start with the simplest path:**
1. Begin with config changes (add bidding_strategy field)
2. Then orchestrator consensus logic (core of M3.1)
3. Then agent pup bidding (simple change)
4. Then CLI multi-agent launch (most complex)
5. Finally example agents and tests

**Implement comprehensive error handling from the beginning:**
- All config validation with clear error messages
- All Redis operations with error handling
- All Docker operations with rollback
- Invalid bid handling (don't fail, treat as ignore)

**Write tests before implementation (TDD approach):**
- Start with unit tests for consensus logic
- Then integration tests with Redis
- Then E2E tests with real agents
- Verify backward compatibility continuously

**Use defensive programming:**
- Validate all bids before storing
- Check consensus count carefully (off-by-one errors possible)
- Alphabetical sort with explicit `sort.Strings()` call
- Health checks with retries and timeouts

### **8.2. Common pitfalls to avoid**

**Orchestrator pitfalls:**

1. **Off-by-one errors in consensus counting**:
   - Ensure `len(bids) == len(agentRegistry)` not `>=`
   - Test with 1, 2, 3, and 10 agents

2. **Race conditions in bid collection**:
   - Don't cache bid count, always query Redis
   - Redis HLEN is atomic and fast

3. **Forgetting to log consensus progress**:
   - Log every bid arrival
   - Log periodic waiting (every 5s)
   - Log consensus achievement with duration

4. **Non-deterministic tie-breaking**:
   - Must use explicit `sort.Strings()`, don't rely on map iteration order
   - Test with multiple runs to verify consistency

**Agent pup pitfalls:**

5. **Hardcoding bid type instead of reading config**:
   - Remove `bidType := "exclusive"`
   - Use `e.config.BiddingStrategy`
   - Test with all four bid types

6. **Missing environment variable handling**:
   - Check `HOLT_BIDDING_STRATEGY` at startup
   - Fail-fast with clear error if missing
   - Don't default to "exclusive" silently

**CLI pitfalls:**

7. **Sequential agent launch (slow)**:
   - Use goroutines + sync.WaitGroup
   - Test that parallel launch is actually faster

8. **Missing health check validation**:
   - Don't report success until all agents healthy
   - Implement rollback if any agent fails
   - Test health check retry logic

9. **Missing rollback on failure**:
   - If any container fails, stop ALL containers
   - Don't leave partial system running
   - Test rollback with simulated failure

### **8.3. Integration checklist**

**Pre-implementation verification:**
- [x] All prerequisite features are complete (Phase 2 M2.1-M2.5)
- [x] No breaking changes to existing contracts (additive only)
- [x] New data structures are backward compatible (holt.yml additive)
- [x] All component interfaces remain stable (blackboard unchanged)

**During implementation:**
- [ ] Orchestrator consensus logic thoroughly tested (unit + integration)
- [ ] Agent pup bidding tested with all four bid types
- [ ] CLI parallel launch tested with multiple agents
- [ ] Example agents created and functional
- [ ] Phase 2 tests still passing (backward compatibility)

**Post-implementation:**
- [ ] All E2E tests passing (3-agent scenarios)
- [ ] Performance benchmarks met (consensus <500ms)
- [ ] Documentation updated (README, agent-development.md)
- [ ] Example holt.yml with multiple agents provided

## **9. Operational readiness**

### **9.1. Monitoring and observability**

**Metrics to track:**

1. **Consensus metrics**:
   - Time to consensus (milliseconds per claim)
   - Bid count per claim (should equal agent count)
   - Invalid bid count (should be zero in healthy system)
   - Grant selection time (microseconds for sorting)

2. **Agent health metrics**:
   - Agent startup time (seconds per agent)
   - Health check success rate (should be 100%)
   - Health check retry count (should be 0-1)
   - Failed agent count (should be zero)

3. **Bid distribution metrics**:
   - Exclusive bid count per claim
   - Review bid count per claim
   - Ignore bid count per claim
   - Tie-breaking frequency (multiple exclusive bidders)

**Structured logging events:**

```json
// Bid arrival event
{"level":"info","component":"orchestrator","event":"bid_received","claim_id":"abc123","agent":"coder-agent","bid_type":"exclusive","timestamp":"2025-10-16T00:00:00Z"}

// Consensus achievement event
{"level":"info","component":"orchestrator","event":"consensus_achieved","claim_id":"abc123","bid_count":3,"duration_ms":150,"timestamp":"2025-10-16T00:00:01Z"}

// Grant decision event
{"level":"info","component":"orchestrator","event":"grant_decision","claim_id":"abc123","winner":"alpha-agent","exclusive_bidders":["alpha-agent","beta-agent"],"selection":"alphabetical","timestamp":"2025-10-16T00:00:02Z"}

// Invalid bid event
{"level":"warn","component":"orchestrator","event":"invalid_bid","claim_id":"abc123","agent":"broken-agent","bid_type":"foobar","action":"treated_as_ignore","timestamp":"2025-10-16T00:00:03Z"}
```

**Health check modifications:**

- Orchestrator `/healthz` remains unchanged (Redis connectivity)
- Agent pup `/healthz` remains unchanged (Redis connectivity)
- No new health endpoints required

**Operator diagnostics:**

- Redis CLI: Inspect bid hashes for any claim
  ```
  redis-cli HGETALL holt:my-instance:claim:abc123:bids
  ```
- Orchestrator logs: Grep for "consensus" to see bid collection
- Agent logs: Grep for "Submitted.*bid" to see agent decisions

### **9.2. Rollback and disaster recovery**

**Feature disable capability:**

- Cannot disable multi-agent support once configured
- Rollback to Phase 2: Use single-agent holt.yml
- **Rollback procedure**:
  1. `holt down` (stop current instance)
  2. Edit holt.yml (remove extra agents)
  3. `holt up` (restart with single agent)

**Rollback procedure for failed deployment:**

1. **Detect failure**: `holt up` reports error or health checks fail
2. **Automatic rollback**: CLI stops all containers automatically
3. **Manual cleanup**: If needed, `docker ps -a | grep holt-agent` and remove
4. **Fix configuration**: Edit holt.yml to correct error
5. **Retry**: Run `holt up` again

**Data migration requirements:**

- None - bid data structure unchanged
- Existing single-agent workflows compatible
- No blackboard migration needed

**Recovery time:**

- Automatic rollback: <5 seconds (container stop time)
- Manual intervention: <1 minute (inspect logs, fix config, retry)
- Zero data loss (no state modification on failure)

### **9.3. Documentation and training**

**Documentation updates required:**

1. **README.md**:
   - Add Phase 3 M3.1 status badge
   - Update feature list (multi-agent support)
   - Add example holt.yml with 3 agents
   - Document M3.1 limitations (review/parallel not executed)

2. **docs/agent-development.md**:
   - Add `bidding_strategy` field documentation
   - Explain four bid types (review, claim, exclusive, ignore)
   - Example agent configurations
   - Tie-breaking behavior

3. **New guide: docs/multi-agent-workflows.md**:
   - How to configure multiple agents
   - Best practices for agent specialization
   - Debugging consensus issues
   - Performance considerations

4. **Example holt.yml**:
   ```yaml
   # Example: Multi-agent workflow with reviewer, coder, and tester
   version: "1.0"
   agents:
     reviewer-agent:
       role: "Reviewer"
       image: "example-reviewer-agent:latest"
       command: ["/app/run.sh"]
       bidding_strategy: "review"
       workspace:
         mode: ro

     coder-agent:
       role: "Coder"
       image: "example-git-agent:latest"
       command: ["/app/run.sh"]
       bidding_strategy: "exclusive"
       workspace:
         mode: rw

     test-agent:
       role: "Tester"
       image: "example-test-agent:latest"
       command: ["/app/run.sh"]
       bidding_strategy: "ignore"
       workspace:
         mode: ro
   ```

**Troubleshooting guides:**

1. **Common issues**:
   - "Consensus waiting forever" â†’ Check agent logs, one may be crashed
   - "Invalid bidding_strategy" â†’ Check holt.yml spelling
   - "Health check timeout" â†’ Increase timeout or check agent image
   - "All agents bid ignore" â†’ Check agent configurations

2. **Debugging commands**:
   ```bash
   # Check agent health
   curl http://localhost:8080/healthz

   # View agent logs
   holt logs coder-agent

   # Inspect bids in Redis
   redis-cli -h localhost -p 6379
   > HGETALL holt:my-instance:claim:abc123:bids

   # Check orchestrator consensus logs
   docker logs holt-orchestrator-my-instance | grep consensus
   ```

**Team training needs:**

- None required - configuration-based, no new skills needed
- Optional: Workshop on designing effective agent specializations
- Optional: Guide on debugging multi-agent workflows

## **10. Self-validation checklist**

### **Before starting implementation:**

- [x] I understand how this feature aligns with Phase 3 (multi-agent coordination)
- [x] All success criteria (section 1.3) are measurable and testable
- [x] I have considered every component in section 2 explicitly
- [x] All design decisions (section 3.1) are justified and documented
- [x] Bidding strategy decision is clear (configuration-based, not LLM)
- [x] Tie-breaking algorithm is deterministic (alphabetical sorting)
- [x] Consensus model is well-defined (wait for all agent bids)

### **During implementation:**

- [ ] I am implementing the simplest solution that meets success criteria
- [ ] All error scenarios (section 6) are being handled, not just happy path
- [ ] Tests are being written before or alongside code (TDD approach)
- [ ] I am validating that existing functionality is not broken (Phase 2 tests)
- [ ] Logging is comprehensive (bid arrival, consensus, grant decision)
- [ ] Invalid bids are handled gracefully (treat as ignore)
- [ ] Alphabetical sorting is explicit (`sort.Strings()`)

### **Before submission:**

- [ ] All items in Definition of Done (section 5) are complete
- [ ] Feature has been tested in a clean environment from scratch
- [ ] Documentation is updated and accurate (README, agent-development.md)
- [ ] I have considered the operational impact (section 9) of this feature
- [ ] All Phase 2 tests pass (backward compatibility validated)
- [ ] E2E tests with 3 agents pass consistently
- [ ] Performance requirements met (consensus <500ms with 5 agents)
- [ ] Example holt.yml with multiple agents provided
