# M3.4 Controller-Worker Pattern - Testing Guide

**Status**: Ready for E2E Testing
**Date**: 2025-10-20

---

## E2E Test Suite Overview

Three comprehensive E2E tests have been implemented to validate M3.4:

### 1. TestE2E_M3_4_BasicControllerWorkerFlow
**Purpose**: Validates the core controller-worker pattern

**Test Steps**:
1. Build example-git-agent Docker image
2. Start Sett instance with controller configuration
3. Verify controller container is running
4. **Verify orchestrator Docker client initialized** (NEW: diagnostic step)
5. Submit goal to trigger workflow
6. Wait for worker to be launched (max 30s)
7. Verify worker completes and exits
8. Verify controller still running (persistent)
9. Verify artefact created by worker

**Expected Behavior**:
- Controller container persistent
- Worker launched when claim granted
- Worker exits after completion
- Artefact created successfully

### 2. TestE2E_M3_4_MaxConcurrentLimit
**Purpose**: Validates max_concurrent worker limit enforcement

**Configuration**: `max_concurrent: 1`

**Test Steps**:
1. Start instance with max_concurrent=1
2. Submit goal
3. Wait for first worker to start
4. Verify only 1 worker running at a time

**Expected Behavior**:
- At most 1 worker active simultaneously
- Additional claims pause when limit reached

### 3. TestE2E_M3_4_BackwardCompatibility
**Purpose**: Validates traditional agents work alongside controllers

**Configuration**: Mix of traditional and controller agents

**Test Steps**:
1. Start instance with both agent types
2. Verify both containers running
3. Submit goal to test mixed workflow
4. Verify orchestrator handles both types

**Expected Behavior**:
- Traditional agents work unchanged
- Controllers work correctly
- No regressions

---

## Running E2E Tests

### Prerequisites

1. **Docker daemon running**
2. **Orchestrator image built**:
   ```bash
   make docker-orchestrator
   ```

3. **Example agent image built**:
   ```bash
   docker build -t example-git-agent:latest \
     -f agents/example-git-agent/Dockerfile .
   ```

### Run Tests

```bash
# Run all E2E tests (requires integration tag)
make test-e2e

# Run specific M3.4 test
go test ./cmd/sett/commands -tags integration \
  -run TestE2E_M3_4_BasicControllerWorkerFlow -v

# Run with timeout
go test ./cmd/sett/commands -tags integration \
  -run TestE2E_M3_4 -v -timeout 5m
```

---

## Troubleshooting E2E Test Failures

### Failure: "Orchestrator did not initialize Docker client"

**Symptom**: Test fails at Step 4 with message about Docker client

**Cause**: Orchestrator cannot access Docker socket

**Debug Steps**:
1. Check if Docker socket is mounted:
   ```bash
   docker inspect sett-orchestrator-{instance} | grep -A 5 "Mounts"
   ```

2. Check orchestrator logs:
   ```bash
   docker logs sett-orchestrator-{instance}
   ```
   Should contain: "Docker client initialized for worker management"
   Should NOT contain: "Warning: Failed to create Docker client"

**Fix**:
- Ensure orchestrator container has `/var/run/docker.sock:/var/run/docker.sock` mount
- Check Docker socket permissions: `ls -la /var/run/docker.sock`
- Verify orchestrator runs with Docker access

### Failure: "Worker container was not launched within timeout"

**Symptom**: Test waits 30s but no worker appears

**Causes**:
1. Docker client not initialized (see above)
2. Worker image missing
3. Grant logic not detecting controller mode
4. Error in LaunchWorker()

**Debug Steps**:
1. Check orchestrator logs for errors:
   ```bash
   docker logs sett-orchestrator-{instance} 2>&1 | grep -E "worker|error|ERROR"
   ```

2. Check if claim was created:
   ```bash
   # Use sett hoard to see artefacts
   sett hoard --name {instance}
   ```

3. Check if controller bid:
   ```bash
   docker logs sett-agent-{instance}-coder-controller | grep bid
   ```

4. Verify worker image exists:
   ```bash
   docker images | grep example-git-agent
   ```

**Expected Log Sequence**:
```
[Orchestrator] Orchestrator starting for instance 'test' with 1 agents
Docker client initialized for worker management
Worker manager initialized for controller-worker pattern
[Orchestrator] Claim granted to controller X
[Orchestrator] event=worker_launching container_name=sett-test-X-worker-abc12345
[Orchestrator] event=worker_launched container_id=...
```

### Failure: "Worker did not complete within timeout"

**Symptom**: Worker launches but never exits

**Causes**:
1. Worker tool script hanging
2. Worker cannot connect to Redis
3. Claim not in correct status

**Debug Steps**:
1. Check worker logs:
   ```bash
   docker ps -a | grep worker
   docker logs {worker-container-id}
   ```

2. Check if worker is still running:
   ```bash
   docker ps | grep worker
   ```

3. Check worker exit code:
   ```bash
   docker ps -a --format "{{.Names}} {{.Status}}" | grep worker
   ```

**Expected Worker Behavior**:
- Starts with `--execute-claim {claim-id}`
- Connects to Redis
- Fetches claim
- Executes tool
- Creates artefact
- Exits with code 0

### Failure: "Traditional agent not running"

**Symptom**: Backward compatibility test fails finding traditional agent

**Debug Steps**:
1. List all containers:
   ```bash
   docker ps -a | grep {instance}
   ```

2. Check agent creation logs in sett up output

3. Verify sett.yml configuration is correct

---

## Manual Testing Procedure

If E2E tests fail, you can test manually:

### Step 1: Create Test Environment

```bash
# Create test directory
mkdir /tmp/m3-4-test
cd /tmp/m3-4-test
git init
git commit --allow-empty -m "Initial commit"

# Create sett.yml
cat > sett.yml << 'EOF'
version: "1.0"

agents:
  coder-controller:
    role: "Coder"
    mode: "controller"
    image: "example-git-agent:latest"
    command: ["/app/cub"]
    bidding_strategy: "exclusive"

    worker:
      image: "example-git-agent:latest"
      max_concurrent: 2
      command: ["/app/run.sh"]
      workspace:
        mode: rw

services:
  redis:
    image: redis:7-alpine
EOF
```

### Step 2: Start Instance

```bash
sett up --name m3-4-test
```

**Expected Output**:
```
âœ“ Started orchestrator container: sett-orchestrator-m3-4-test
```

### Step 3: Verify Orchestrator Initialized

```bash
docker logs sett-orchestrator-m3-4-test 2>&1 | grep -E "Docker|Worker"
```

**Expected Output**:
```
Docker client initialized for worker management
Worker manager initialized for controller-worker pattern
```

### Step 4: Submit Goal

```bash
sett forage --goal "Create README" --name m3-4-test
```

### Step 5: Watch for Worker

```bash
# In one terminal, watch for worker creation
watch -n 1 'docker ps -a | grep worker'

# In another terminal, monitor orchestrator logs
docker logs -f sett-orchestrator-m3-4-test
```

**Expected Sequence**:
1. Controller bids on claim
2. Orchestrator grants to controller
3. Orchestrator launches worker: `sett-m3-4-test-coder-controller-worker-{claim}`
4. Worker executes claim
5. Worker exits (status: Exited (0))
6. Orchestrator cleans up worker

### Step 6: Verify Results

```bash
# List artefacts
sett hoard --name m3-4-test

# Check Git history
git log --oneline

# List all containers (worker should be exited/removed)
docker ps -a | grep m3-4-test
```

### Step 7: Cleanup

```bash
sett down --name m3-4-test
cd ..
rm -rf /tmp/m3-4-test
```

---

## Common Issues and Solutions

### Issue: Docker Socket Permission Denied

**Error**: `permission denied while trying to connect to the Docker daemon socket`

**Solution**:
```bash
# Check Docker socket permissions
ls -la /var/run/docker.sock

# If needed, add user to docker group
sudo usermod -aG docker $USER
newgrp docker
```

### Issue: Orchestrator Image Not Found

**Error**: `Failed to find orchestrator image: sett-orchestrator:latest`

**Solution**:
```bash
# Build orchestrator image
make docker-orchestrator

# Verify image exists
docker images | grep sett-orchestrator
```

### Issue: Worker Image Not Found

**Error**: Container create fails with "image not found"

**Solution**:
```bash
# Build agent image
docker build -t example-git-agent:latest \
  -f agents/example-git-agent/Dockerfile .
```

### Issue: Network Already Exists

**Error**: `network with name sett-network-X already exists`

**Solution**:
```bash
# Clean up existing instance
sett down --name {instance}

# If that fails, manual cleanup
docker network rm sett-network-{instance}
```

---

## Test Performance Benchmarks

**Expected Timings**:
- Instance startup: < 5s
- Worker launch: < 1s
- Worker execution: < 10s (depends on tool)
- Worker cleanup: < 1s
- Full test: < 30s

**If slower**:
- Check Docker resource limits
- Check orchestrator logs for delays
- Verify network latency to Docker daemon

---

## Diagnostic Commands Reference

```bash
# List all Sett containers
docker ps -a --filter "label=sett.project=true"

# Show orchestrator logs
docker logs sett-orchestrator-{instance}

# Show controller logs
docker logs sett-agent-{instance}-{controller}

# Show worker logs (if still exists)
docker logs sett-{instance}-{controller}-worker-{claim}

# Check worker count
docker ps -a | grep worker | wc -l

# Monitor orchestrator events
docker logs -f sett-orchestrator-{instance} | grep -E "worker_|grant"

# Check Redis keys
docker exec sett-redis-{instance} redis-cli KEYS "*worker*"
```

---

## Next Steps After E2E Tests Pass

1. **Performance Testing**
   - Submit multiple goals rapidly
   - Verify max_concurrent enforcement
   - Measure worker launch latency

2. **Stress Testing**
   - Run with high max_concurrent (10+)
   - Submit 100+ goals
   - Monitor resource usage

3. **Failure Scenarios**
   - Kill worker mid-execution
   - Disconnect Docker socket
   - Fill disk/memory

4. **Production Validation**
   - Test with real agent workloads
   - Monitor for worker orphans
   - Verify cleanup behavior

---

## E2E Test Implementation Details

**Test Framework**: Go testing with testify/require

**Test Tags**: `// +build integration` (prevents running in unit tests)

**Test Utilities**:
- `testutil.SetupE2EEnvironment()` - Creates temp workspace
- `testutil.GetProjectRoot()` - Gets project root for Docker builds

**Test Cleanup**: Uses defer to ensure `sett down` runs even if test fails

**Test Timeouts**:
- Worker launch wait: 30s
- Overall test timeout: 5m (configurable)

---

## Success Criteria Checklist

For M3.4 E2E tests to pass, all of the following must be true:

- [ ] Orchestrator Docker client initializes successfully
- [ ] Controller container starts and stays healthy
- [ ] Controller submits bids on claims
- [ ] Orchestrator detects controller mode
- [ ] Worker container launches within 1s of grant
- [ ] Worker has correct naming: `sett-{instance}-{agent}-worker-{claim}`
- [ ] Worker executes claim successfully
- [ ] Worker exits with code 0
- [ ] Worker container is removed after exit
- [ ] Controller remains running after worker exits
- [ ] Artefact created by worker appears in blackboard
- [ ] Traditional agents continue working (backward compat)
- [ ] Max concurrent limit enforced (if configured)

All criteria validated by the 3 E2E tests.
