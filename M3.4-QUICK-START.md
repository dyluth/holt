# M3.4 Controller-Worker Pattern - Quick Start Guide

## Prerequisites

Before running M3.4 E2E tests or using controller-worker pattern:

### 1. Rebuild Orchestrator Image ⚠️ CRITICAL

The orchestrator needs to be rebuilt with M3.4 Docker client support:

```bash
make docker-orchestrator
```

**Why?** The M3.4 orchestrator includes:
- Docker client initialization
- WorkerManager for container lifecycle
- Docker socket access for launching workers

**Verify build:**
```bash
docker images holt-orchestrator:latest
# Should show recent timestamp
```

### 2. Build Example Agent Image

```bash
docker build -t example-git-agent:latest \
  -f agents/example-git-agent/Dockerfile .
```

### 3. Verify Images Exist

```bash
docker images | grep -E "holt-orchestrator|example-git-agent"
```

Expected output:
```
holt-orchestrator    latest   <recent-id>   <recent-time>   ...
example-git-agent    latest   <id>          <time>          ...
```

---

## Running E2E Tests

### Quick Test

```bash
make test-e2e
```

### Specific M3.4 Test

```bash
go test ./cmd/holt/commands -tags integration \
  -run TestE2E_M3_4_BasicControllerWorkerFlow -v
```

### Expected Success Output

```
Step 4: Verifying orchestrator Docker client...
✓ Orchestrator Docker client initialized

Step 6: Waiting for worker to execute claim...
✓ Worker container launched: holt-{instance}-coder-controller-worker-{claim}
✓ Worker completed and exited

Step 7: Verifying controller is still running...
✓ Controller still running (persistent)

PASS
```

---

## Common Issues

### Issue: "Orchestrator did not initialize Docker client"

**Cause:** Orchestrator image not rebuilt with M3.4 code

**Fix:**
```bash
make docker-orchestrator
# Then re-run tests
```

### Issue: "Worker container was not launched"

**Causes:**
1. Orchestrator Docker client not initialized (see above)
2. Docker socket not accessible
3. Worker image missing

**Debug:**
```bash
# Check orchestrator logs
docker logs holt-orchestrator-{instance}

# Should contain:
# "Docker client initialized for worker management"
# "Worker manager initialized for controller-worker pattern"
```

### Issue: Docker Socket Permission Denied

**macOS/Linux:**
```bash
# Verify Docker socket exists
ls -la /var/run/docker.sock

# Ensure Docker daemon is running
docker ps
```

---

## Manual Testing

### Create Test Instance

```bash
mkdir /tmp/m3-4-manual-test
cd /tmp/m3-4-manual-test
git init
git commit --allow-empty -m "Initial commit"

cat > holt.yml << 'EOF'
version: "1.0"

agents:
  coder-controller:
    role: "Coder"
    mode: "controller"
    image: "example-git-agent:latest"
    command: ["/app/pup"]
    bidding_strategy: "exclusive"

    worker:
      image: "example-git-agent:latest"
      max_concurrent: 2
      command: ["/app/run.sh"]
      workspace:
        mode: rw

services:
  redis:
    image: redis:7-alpine
EOF

holt up
```

### Verify Orchestrator Initialized

```bash
docker logs holt-orchestrator-default-1 2>&1 | grep -E "Docker|Worker"
```

Expected:
```
Docker client initialized for worker management
Worker manager initialized for controller-worker pattern
```

### Submit Goal and Watch Workers

```bash
# In terminal 1: Watch for workers
watch -n 1 'docker ps -a | grep worker'

# In terminal 2: Submit goal
holt forage --goal "Create README.md"

# In terminal 3: Monitor orchestrator
docker logs -f holt-orchestrator-default-1
```

### Cleanup

```bash
holt down
cd .. && rm -rf /tmp/m3-4-manual-test
```

---

## What's New in M3.4

### Orchestrator Changes
- Docker client initialization on startup
- WorkerManager component for container lifecycle
- Docker socket mount: `/var/run/docker.sock:/var/run/docker.sock`
- Worker launch/monitor/cleanup logic

### Pup Changes
- `HOLT_MODE=controller` environment variable support
- `--execute-claim <id>` flag for worker mode
- Mode detection: controller vs worker vs traditional

### Configuration Changes
- `mode: "controller"` agent field
- `worker:` nested configuration block
- `max_concurrent` concurrency limit

---

## Success Checklist

Before considering M3.4 working, verify:

- [ ] Orchestrator image rebuilt (`make docker-orchestrator`)
- [ ] Orchestrator logs show "Docker client initialized"
- [ ] Controller container starts and stays running
- [ ] Worker launches when claim granted
- [ ] Worker exits after execution
- [ ] Worker is cleaned up automatically
- [ ] Controller remains running after worker exits
- [ ] E2E tests pass

---

## Next Steps After Tests Pass

1. **Performance testing** - Submit multiple goals
2. **Stress testing** - Test max_concurrent limits
3. **Production validation** - Real agent workloads
4. **Monitoring** - Watch for worker orphans

---

## Key Documentation

- **Full Design**: `design/features/phase-3-coordination/M3.4-controller-worker-pattern.md`
- **Implementation Summary**: `design/features/phase-3-coordination/M3.4-IMPLEMENTATION-SUMMARY.md`
- **Testing Guide**: `design/features/phase-3-coordination/M3.4-TESTING-GUIDE.md`
- **Example Config**: `holt.controller-worker.example.yml`

---

## Critical: Always Rebuild Orchestrator

**Remember:** After any orchestrator code changes, especially M3.4 Docker client support:

```bash
make docker-orchestrator
```

The E2E tests will fail with "Orchestrator did not initialize Docker client" if using an old image.
